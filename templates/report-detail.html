{% extends "base.html" %}

{% block title %}Report Detail - NCRT{% endblock %}

{% block breadcrumb_current %}Report Detail{% endblock %}

{% block content %}
<section class="bg-white rounded-lg shadow p-6">
    <h2 class="text-2xl font-bold mb-4">Report Detail</h2>
    <div id="reportDetailContent">
        <p class="text-gray-500">Loading report details...</p>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
    // Simplified report detail - full report-detail.js should be inlined here
    async function apiRequest(url, method = 'GET', data = null) {
        const options = { method, headers: { 'Content-Type': 'application/json' } };
        if (data && method !== 'GET') options.body = JSON.stringify(data);
        try {
            const response = await fetch(url, options);
            const result = await response.json();
            return { ok: response.ok, data: result, status: response.status };
        } catch (error) {
            console.error('API request failed:', error);
            return { ok: false, error: error.message };
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const auditId = urlParams.get('audit_id');
        if (auditId) {
            loadReportDetail(auditId);
        }
    });
    
    async function loadReportDetail(auditId) {
        const result = await apiRequest(`/api/reports?audit_id=${auditId}`);
        if (result.ok && result.data) {
            const container = document.getElementById('reportDetailContent');
            const audit = result.data;
            container.innerHTML = `
                <div class="mb-6">
                    <h3 class="text-xl font-bold">${escapeHtml(audit.device_identifier || 'Unknown')}</h3>
                    <p class="text-gray-600">Status: ${audit.status}</p>
                    <p class="text-gray-600">Created: ${audit.created_at_formatted || audit.created_at || 'Unknown'}</p>
                </div>
                <div>
                    <h4 class="font-semibold mb-4">Findings</h4>
                    <div class="space-y-4">
                        ${(audit.findings || []).map(f => `
                            <div class="border border-gray-200 rounded-lg p-4">
                                <div class="flex justify-between items-start mb-2">
                                    <h5 class="font-semibold">${escapeHtml(f.rule_name || 'Unknown Rule')}</h5>
                                    <span class="px-2 py-1 rounded text-xs ${f.severity === 'critical' ? 'bg-red-100 text-red-800' : f.severity === 'high' ? 'bg-orange-100 text-orange-800' : 'bg-yellow-100 text-yellow-800'}">${f.severity}</span>
                                </div>
                                <p class="text-gray-700 mb-2">${escapeHtml(f.message || '')}</p>
                                ${f.remediation ? `<p class="text-sm text-blue-600"><strong>Remediation:</strong> ${escapeHtml(f.remediation)}</p>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
    }
</script>
{% endblock %}
