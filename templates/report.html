{% extends "base.html" %}

{% block title %}Report - NCRT{% endblock %}

{% block breadcrumb_current %}Report{% endblock %}

{% block content %}
<section class="bg-white rounded-lg shadow p-6 mb-6">
    <div class="mb-6">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h2 class="text-2xl font-bold">Reports</h2>
                <p class="text-gray-600 text-sm mt-1">View and manage audit reports</p>
            </div>
            <div id="bulkActions" class="hidden flex items-center gap-2">
                <button onclick="bulkDeleteAudits()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 flex items-center gap-2">
                    <i class="fas fa-trash"></i>
                    Delete Selected
                </button>
            </div>
        </div>
        
        <!-- Search and Filter Bar -->
        <div class="bg-gray-50 rounded-lg p-4 mb-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="md:col-span-2">
                    <label for="searchInput" class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="Search by device, config file, or status..."
                            class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                </div>
                <div>
                    <label for="statusFilter" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="statusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">All Status</option>
                        <option value="Completed">Completed</option>
                        <option value="Failed">Failed</option>
                        <option value="Processing">Processing</option>
                        <option value="Pending">Pending</option>
                    </select>
                </div>
                <div>
                    <label for="dateFilter" class="block text-sm font-medium text-gray-700 mb-1">Date Range</label>
                    <select id="dateFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">All Time</option>
                        <option value="7">Last 7 days</option>
                        <option value="30">Last 30 days</option>
                        <option value="90">Last 90 days</option>
                    </select>
                </div>
                        </div>
            <div class="mt-3 flex justify-end gap-2">
                <button onclick="clearFilters()" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-100">
                    Clear Filters
                            </button>
                        </div>
        </div>
    </div>
    
    <div id="reportContent" class="space-y-4">
        <p class="text-gray-500">Loading audits...</p>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
    // Simplified report view - full report.js should be inlined here
    async function apiRequest(url, method = 'GET', data = null) {
        const options = { method, headers: { 'Content-Type': 'application/json' } };
        if (data && method !== 'GET') options.body = JSON.stringify(data);
        try {
            const response = await fetch(url, options);
            const result = await response.json();
            return { ok: response.ok, data: result, status: response.status };
        } catch (error) {
            console.error('API request failed:', error);
            return { ok: false, error: error.message };
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const auditId = urlParams.get('audit_id');
        if (auditId) {
            loadReport(auditId);
        } else {
            loadAuditList();
        }
    });
    
    let selectedAudits = new Set();
    
    async function loadAuditList() {
        const searchQuery = document.getElementById('searchInput')?.value || '';
        const statusFilter = document.getElementById('statusFilter')?.value || '';
        const dateFilter = document.getElementById('dateFilter')?.value || '';
        
        // Build query parameters
        const params = new URLSearchParams();
        params.append('history', 'true');
        if (searchQuery) params.append('search', searchQuery);
        if (statusFilter) params.append('status', statusFilter);
        if (dateFilter) params.append('date_range', dateFilter);
        
        const result = await apiRequest(`/api/audits?${params.toString()}`);
        const container = document.getElementById('reportContent');
        
        if (result.ok && result.data) {
            const audits = result.data.audits || [];
            if (audits.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-inbox text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-500 text-lg">No audits found</p>
                        <p class="text-gray-400 text-sm mt-2">${(searchQuery || statusFilter || dateFilter) ? 'Try adjusting your filters' : 'Create your first audit to get started'}</p>
                    </div>
                `;
                document.getElementById('bulkActions').classList.add('hidden');
                return;
            }
            
            container.innerHTML = audits.map(audit => {
                const statusColors = {
                    'Completed': 'bg-green-100 text-green-800',
                    'Failed': 'bg-red-100 text-red-800',
                    'Processing': 'bg-yellow-100 text-yellow-800',
                    'Pending': 'bg-gray-100 text-gray-800'
                };
                const statusColor = statusColors[audit.status] || 'bg-gray-100 text-gray-800';
                const findingCount = audit.finding_count || 0;
                
                return `
                    <div class="border border-gray-200 rounded-lg p-5 hover:shadow-md transition-shadow bg-white">
                        <div class="flex items-start gap-4">
                            <div class="mt-1">
                                <input type="checkbox" class="audit-checkbox w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" 
                                    value="${audit.id}" onchange="updateBulkActions()">
                            </div>
                            <div class="flex-1">
                                <div class="flex items-start justify-between mb-3">
                                    <div class="flex-1">
                                        <h3 class="text-lg font-semibold text-gray-900 mb-1">${escapeHtml(audit.device_identifier || 'Unknown Device')}</h3>
                                        <div class="flex flex-wrap items-center gap-3 text-sm text-gray-600">
                                            ${audit.config_file ? `<span><i class="fas fa-file-alt mr-1"></i>${escapeHtml(audit.config_file)}</span>` : ''}
                                            ${audit.device_hostname ? `<span><i class="fas fa-server mr-1"></i>${escapeHtml(audit.device_hostname)}</span>` : ''}
                                            ${audit.device_model ? `<span><i class="fas fa-microchip mr-1"></i>${escapeHtml(audit.device_model)}</span>` : ''}
                                        </div>
                                    </div>
                                    <span class="px-3 py-1 rounded-full text-xs font-medium ${statusColor}">${audit.status || 'Unknown'}</span>
                        </div>
                                
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 text-sm">
                                    <div>
                                        <span class="text-gray-500">Created:</span>
                                        <p class="font-medium">${audit.created_at_formatted || audit.created_at || 'Unknown'}</p>
                                    </div>
                                    <div>
                                        <span class="text-gray-500">Findings:</span>
                                        <p class="font-medium">${findingCount}</p>
                                    </div>
                                    ${audit.device_family ? `
                                    <div>
                                        <span class="text-gray-500">Family:</span>
                                        <p class="font-medium">${escapeHtml(audit.device_family)}</p>
                                    </div>
                                    ` : ''}
                                    ${audit.device_location ? `
                                    <div>
                                        <span class="text-gray-500">Location:</span>
                                        <p class="font-medium">${escapeHtml(audit.device_location)}</p>
                                    </div>
                                    ` : ''}
                                </div>
                                
                                <div class="flex gap-2">
                                    <a href="?audit_id=${audit.id}" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2 text-sm">
                                        <i class="fas fa-eye"></i>
                                        View Report
                                    </a>
                                    <button onclick="openExportModalForAudit(${audit.id})" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 flex items-center gap-2 text-sm">
                                        <i class="fas fa-download"></i>
                                        Export
                                </button>
                                    <button onclick="deleteAudit(${audit.id}, '${escapeHtml(audit.device_identifier || 'Unknown')}')" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 flex items-center gap-2 text-sm">
                                        <i class="fas fa-trash"></i>
                                        Delete
                                </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            updateBulkActions();
        } else {
            container.innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-4"></i>
                    <p class="text-red-600 text-lg">Error loading audits</p>
                    <p class="text-gray-400 text-sm mt-2">${result.error || 'Unknown error occurred'}</p>
                </div>
            `;
        }
    }
    
    function updateBulkActions() {
        const checkboxes = document.querySelectorAll('.audit-checkbox:checked');
        const bulkActions = document.getElementById('bulkActions');
        if (checkboxes.length > 0) {
            bulkActions.classList.remove('hidden');
            selectedAudits = new Set(Array.from(checkboxes).map(cb => cb.value));
        } else {
            bulkActions.classList.add('hidden');
            selectedAudits.clear();
        }
    }
    
    function clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('dateFilter').value = '';
        loadAuditList();
    }
    
    function deleteAudit(auditId, deviceIdentifier) {
        if (!confirm(`Are you sure you want to delete the audit for "${deviceIdentifier}"?\n\nThis action cannot be undone.`)) {
            return;
        }
        
        const result = apiRequest('/api/audits', 'POST', {
            action: 'delete',
            audit_id: auditId
        });
        
        result.then(res => {
            if (res.ok) {
                showToast('Audit deleted successfully', 'success');
                loadAuditList();
            } else {
                showToast(res.data?.error || 'Failed to delete audit', 'error');
            }
        });
    }
    
    function bulkDeleteAudits() {
        if (selectedAudits.size === 0) {
            showToast('No audits selected', 'error');
            return;
        }
        
        if (!confirm(`Are you sure you want to delete ${selectedAudits.size} audit(s)?\n\nThis action cannot be undone.`)) {
            return;
        }
        
        // Delete audits one by one
        const deletePromises = Array.from(selectedAudits).map(auditId => 
            apiRequest('/api/audits', 'POST', {
                action: 'delete',
                audit_id: parseInt(auditId)
            })
        );
        
        Promise.all(deletePromises).then(results => {
            const successCount = results.filter(r => r.ok).length;
            const failCount = results.length - successCount;
            
            if (failCount === 0) {
                showToast(`Successfully deleted ${successCount} audit(s)`, 'success');
            } else {
                showToast(`Deleted ${successCount} audit(s), ${failCount} failed`, 'warning');
            }
            
            selectedAudits.clear();
            loadAuditList();
        });
    }
    
    function openExportModalForAudit(auditId) {
        currentAuditId = auditId;
        openExportModal();
    }
    
    // Add event listeners for search and filters
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const auditId = urlParams.get('audit_id');
        if (auditId) {
            loadReport(auditId);
        } else {
            loadAuditList();
            
            // Add event listeners for search and filters
            const searchInput = document.getElementById('searchInput');
            const statusFilter = document.getElementById('statusFilter');
            const dateFilter = document.getElementById('dateFilter');
            
            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(loadAuditList, 300);
                });
            }
            
            if (statusFilter) {
                statusFilter.addEventListener('change', loadAuditList);
            }
            
            if (dateFilter) {
                dateFilter.addEventListener('change', loadAuditList);
            }
        }
    });
    
    let currentAuditId = null;
    
    async function loadReport(auditId) {
        currentAuditId = auditId;
        const result = await apiRequest(`/api/reports?audit_id=${auditId}`);
        if (result.ok && result.data) {
            const container = document.getElementById('reportContent');
            const audit = result.data;
            
            const statusColors = {
                'Completed': 'bg-green-100 text-green-800',
                'Failed': 'bg-red-100 text-red-800',
                'Processing': 'bg-yellow-100 text-yellow-800',
                'Pending': 'bg-gray-100 text-gray-800'
            };
            const statusColor = statusColors[audit.status] || 'bg-gray-100 text-gray-800';
            
            container.innerHTML = `
                <div class="mb-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <div class="flex items-center gap-3 mb-2">
                                <h3 class="text-2xl font-bold">${escapeHtml(audit.device_identifier || 'Unknown')}</h3>
                                <span class="px-3 py-1 rounded-full text-sm font-medium ${statusColor}">${audit.status || 'Unknown'}</span>
                            </div>
                            <div class="flex flex-wrap gap-4 text-sm text-gray-600">
                                ${audit.config_file ? `<span><i class="fas fa-file-alt mr-1"></i>${escapeHtml(audit.config_file)}</span>` : ''}
                                ${audit.device_hostname ? `<span><i class="fas fa-server mr-1"></i>${escapeHtml(audit.device_hostname)}</span>` : ''}
                                ${audit.device_model ? `<span><i class="fas fa-microchip mr-1"></i>${escapeHtml(audit.device_model)}</span>` : ''}
                                ${audit.created_at_formatted ? `<span><i class="fas fa-calendar mr-1"></i>${audit.created_at_formatted}</span>` : ''}
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <a href="?" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 flex items-center gap-2">
                                <i class="fas fa-arrow-left"></i>
                                Back to List
                            </a>
                            <button onclick="openExportModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                                <i class="fas fa-download"></i>
                                Export Report
                            </button>
                        </div>
            </div>
                </div>
                
                <!-- Findings Search and Filter -->
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="md:col-span-2">
                            <input type="text" id="findingsSearch" placeholder="Search findings..."
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <select id="findingsSeverityFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">All Severities</option>
                                <option value="critical">Critical</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                    </select>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h4 class="font-semibold mb-2">Findings (<span id="findingsCount">${audit.findings?.length || 0}</span>)</h4>
                    <div id="findingsList" class="space-y-2">
                        ${renderFindings(audit.findings || [])}
                    </div>
                </div>
            `;
            
            // Add event listeners for findings search/filter
            const findingsSearch = document.getElementById('findingsSearch');
            const findingsSeverityFilter = document.getElementById('findingsSeverityFilter');
            const allFindings = audit.findings || [];
            
            function filterFindings() {
                const searchQuery = findingsSearch.value.toLowerCase();
                const severityFilter = findingsSeverityFilter.value.toLowerCase();
                
                const filtered = allFindings.filter(f => {
                    const matchesSearch = !searchQuery || 
                        (f.rule_name || '').toLowerCase().includes(searchQuery) ||
                        (f.message || '').toLowerCase().includes(searchQuery);
                    const matchesSeverity = !severityFilter || (f.severity || '').toLowerCase() === severityFilter;
                    return matchesSearch && matchesSeverity;
                });
                
                document.getElementById('findingsCount').textContent = filtered.length;
                document.getElementById('findingsList').innerHTML = renderFindings(filtered);
            }
            
            if (findingsSearch) {
                findingsSearch.addEventListener('input', filterFindings);
            }
            if (findingsSeverityFilter) {
                findingsSeverityFilter.addEventListener('change', filterFindings);
            }
        }
    }
    
    function renderFindings(findings) {
        if (findings.length === 0) {
            return '<p class="text-gray-500 text-center py-8">No findings to display</p>';
        }
        
        return findings.map(f => {
            const severityColors = {
                'critical': 'bg-red-100 text-red-800 border-red-300',
                'high': 'bg-orange-100 text-orange-800 border-orange-300',
                'medium': 'bg-yellow-100 text-yellow-800 border-yellow-300',
                'low': 'bg-blue-100 text-blue-800 border-blue-300'
            };
            const severityColor = severityColors[f.severity?.toLowerCase()] || 'bg-gray-100 text-gray-800 border-gray-300';
            
            return `
                <div class="border ${severityColor} rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <h5 class="font-semibold text-lg">${escapeHtml(f.rule_name || 'Unknown Rule')}</h5>
                                <span class="px-2 py-1 rounded text-xs font-medium ${severityColor}">${f.severity || 'medium'}</span>
                            </div>
                            <p class="text-sm text-gray-700 mb-2">${escapeHtml(f.message || 'No description')}</p>
                            ${f.config_path ? `<p class="text-xs text-gray-600"><i class="fas fa-map-marker-alt mr-1"></i>${escapeHtml(f.config_path)}</p>` : ''}
                            ${f.remediation ? `<div class="mt-3 pt-3 border-t border-current border-opacity-20"><p class="text-sm"><strong>Remediation:</strong> ${escapeHtml(f.remediation)}</p></div>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    function openExportModal() {
        if (!currentAuditId) {
            showToast('No audit selected', 'error');
            return;
        }
        
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
        const defaultFilename = `audit_report_${currentAuditId}_${timestamp}`;
        
        const modalHTML = `
            <div id="exportModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
                        <h3 class="text-xl font-bold">Export Report</h3>
                        <button onclick="closeExportModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <form id="exportForm" class="p-6 space-y-4">
                        <div>
                            <label for="exportFormat" class="block text-sm font-medium text-gray-700 mb-1">
                                Format <span class="text-red-500">*</span>
                            </label>
                            <select id="exportFormat" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="pdf">PDF (Professional Report)</option>
                                <option value="csv">CSV (Spreadsheet Data)</option>
                                <option value="html_standalone">HTML Standalone (Viewable in Browser)</option>
                                <option value="json">JSON (Structured Data)</option>
                            </select>
            </div>
                        
                        <div>
                            <label for="exportPreset" class="block text-sm font-medium text-gray-700 mb-1">
                                Preset
                            </label>
                            <select id="exportPreset"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Custom</option>
                                <option value="full">Full Report</option>
                                <option value="executive">Executive Summary</option>
                                <option value="findings_only">Findings Only</option>
                                <option value="compliance">Compliance Report</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Select a preset to automatically configure sections</p>
            </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Include Sections</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" name="sections" value="statistics" checked class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <span class="ml-2 text-sm text-gray-700">Statistics</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="sections" value="findings" checked class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <span class="ml-2 text-sm text-gray-700">Findings</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="sections" value="compliance" checked class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <span class="ml-2 text-sm text-gray-700">Compliance</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="sections" value="charts" checked class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <span class="ml-2 text-sm text-gray-700">Charts</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="sections" value="executive_summary" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <span class="ml-2 text-sm text-gray-700">Executive Summary</span>
                                </label>
        </div>
    </div>
    
                        <div>
                            <label for="exportFilename" class="block text-sm font-medium text-gray-700 mb-1">
                                Filename
                            </label>
                            <input type="text" id="exportFilename" value="${defaultFilename}"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-500 mt-1">File extension will be added automatically</p>
                        </div>
                        
                        <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
                            <button type="button" onclick="closeExportModal()"
                                class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                                Cancel
                            </button>
                            <button type="submit"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                <i class="fas fa-download mr-2"></i>Export
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('exportModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        // Add form submit handler
        document.getElementById('exportForm').addEventListener('submit', handleExportSubmit);
        
        // Handle preset changes
        document.getElementById('exportPreset').addEventListener('change', handlePresetChange);
        
        // Close modal when clicking outside
        document.getElementById('exportModal').addEventListener('click', function(e) {
            if (e.target.id === 'exportModal') {
                closeExportModal();
            }
        });
        
        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('exportModal')) {
                closeExportModal();
            }
        });
    }
    
    function closeExportModal() {
        const modal = document.getElementById('exportModal');
        if (modal) {
            modal.remove();
        }
    }
    
    function handlePresetChange() {
        const preset = document.getElementById('exportPreset').value;
        const checkboxes = document.querySelectorAll('input[name="sections"]');
        
        // Uncheck all first
        checkboxes.forEach(cb => cb.checked = false);
        
        // Apply preset
        switch(preset) {
            case 'full':
                checkboxes.forEach(cb => {
                    if (['statistics', 'findings', 'compliance', 'charts'].includes(cb.value)) {
                        cb.checked = true;
                    }
                });
                break;
            case 'executive':
                checkboxes.forEach(cb => {
                    if (['statistics', 'compliance'].includes(cb.value)) {
                        cb.checked = true;
                    }
                });
                break;
            case 'findings_only':
                checkboxes.forEach(cb => {
                    if (cb.value === 'findings') {
                        cb.checked = true;
                    }
                });
                break;
            case 'compliance':
                checkboxes.forEach(cb => {
                    if (['statistics', 'compliance'].includes(cb.value)) {
                        cb.checked = true;
                    }
                });
                break;
        }
    }
    
    async function handleExportSubmit(e) {
        e.preventDefault();
        
        const format = document.getElementById('exportFormat').value;
        const preset = document.getElementById('exportPreset').value;
        const filename = document.getElementById('exportFilename').value.trim() || `audit_report_${currentAuditId}`;
        
        // Get selected sections
        const selectedSections = Array.from(document.querySelectorAll('input[name="sections"]:checked')).map(cb => cb.value);
        if (selectedSections.length === 0) {
            showToast('Please select at least one section to include', 'error');
            return;
        }
        
        const exportButton = e.target.querySelector('button[type="submit"]');
        const originalText = exportButton.innerHTML;
        exportButton.disabled = true;
        exportButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Exporting...';
        
        try {
            // Build query parameters
            const params = new URLSearchParams();
            params.append('audit_id', currentAuditId);
            params.append('format', format);
            params.append('sections', selectedSections.join(','));
            if (preset) params.append('preset', preset);
            params.append('filename', filename);
            params.append('include_statistics', selectedSections.includes('statistics') ? 'true' : 'false');
            params.append('include_compliance', selectedSections.includes('compliance') ? 'true' : 'false');
            
            const url = `/api/reports?${params.toString()}`;
            
            if (format === 'json') {
                // JSON is returned as JSON response
                const response = await fetch(url);
                if (!response.ok) {
                    let errorData;
                    try {
                        errorData = await response.json();
                    } catch (e) {
                        errorData = { error: await response.text() };
                    }
                    throw new Error(errorData.error || 'Export failed');
                }
                const jsonData = await response.json();
                const jsonString = JSON.stringify(jsonData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                downloadFile(blob, `${filename}.json`);
            } else {
                // Binary formats (PDF, CSV, HTML) - trigger download directly
                // Use window.open for better browser compatibility
                window.open(url, '_blank');
                
                // Also try direct download as fallback
                setTimeout(() => {
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `${filename}.${format === 'html_standalone' ? 'html' : format}`;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    setTimeout(() => {
                        document.body.removeChild(link);
                    }, 100);
                }, 100);
            }
            
            showToast('Report exported successfully', 'success');
            closeExportModal();
        } catch (error) {
            console.error('Export failed:', error);
            showToast(error.message || 'Export failed', 'error');
        } finally {
            exportButton.disabled = false;
            exportButton.innerHTML = originalText;
        }
    }
    
    function downloadFile(blob, filename) {
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
    }
    
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function showToast(message, type = 'info') {
        console.log(`Toast (${type}): ${message}`);
        // In a real app, this would display a visual toast notification
    }
</script>
{% endblock %}
